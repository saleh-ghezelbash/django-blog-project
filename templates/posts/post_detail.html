{% extends 'base.html' %}
{% load static %}

{% block content %}
<section class="pt-0">
    <div class="container position-relative" data-sticky-container>
        <div class="row">
            <!-- Main Content START -->
            <div class="col-lg-9 mb-5">
                <!-- Post Content -->
                <p><span class="dropcap bg-dark text-white px-2">{{ post.content|slice:":1" }}</span>{{ post.content|safe }}</p>

                <!-- Post Images -->
                {% if post.images.all %}
                <div class="row g-2 my-5">
                    {% for image in post.images.all %}
                    <div class="col-md-4">
                        <a href="{{ image.image.url }}" data-glightbox data-gallery="image-popup">
                            <img class="rounded" src="{{ image.image.url }}" alt="{{ image.caption|default:post.title }}" style="width: 100%; height: 200px; object-fit: cover;">
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Author info START -->
                <div class="d-flex p-2 p-md-4 my-3 bg-primary bg-opacity-10 rounded">
                    <!-- Avatar -->
                    <a href="{% url 'user_profile' post.author.username %}">
                        <div class="avatar avatar-xxl me-2 me-md-4">
                            {% if post.author.profile_picture %}
                            <img class="avatar-img rounded-circle" src="{{ post.author.profile_picture.url }}" alt="{{ post.author.username }}">
                            {% else %}
                            <div class="avatar-img rounded-circle bg-primary d-flex align-items-center justify-content-center text-white">
                                {{ post.author.username|slice:":1"|upper }}
                            </div>
                            {% endif %}
                        </div>
                    </a>
                    <!-- Info -->
                    <div>
                        <div class="d-sm-flex align-items-center justify-content-between">
                            <div>
                                <h4 class="m-0"><a href="{% url 'user_profile' post.author.username %}">{{ post.author.get_full_name|default:post.author.username }}</a></h4>
                                <small>Author</small>
                            </div>
                            <a href="{% url 'user_profile' post.author.username %}" class="btn btn-xs btn-primary-soft">View Profile</a>
                        </div>
                        <p class="my-2">{{ post.author.bio|default:"This author hasn't added a bio yet." }}</p>
                        <!-- Social icons -->
                        <ul class="nav">
                            {% if post.author.website %}
                            <li class="nav-item">
                                <a class="nav-link ps-0 pe-2 fs-5" href="{{ post.author.website }}" target="_blank"><i class="bi bi-globe"></i></a>
                            </li>
                            {% endif %}
                            {% if post.author.twitter %}
                            <li class="nav-item">
                                <a class="nav-link px-2 fs-5" href="https://twitter.com/{{ post.author.twitter }}" target="_blank"><i class="bi bi-twitter-x"></i></a>
                            </li>
                            {% endif %}
                            {% if post.author.facebook %}
                            <li class="nav-item">
                                <a class="nav-link px-2 fs-5" href="https://facebook.com/{{ post.author.facebook }}" target="_blank"><i class="bi bi-facebook"></i></a>
                            </li>
                            {% endif %}
                            {% if post.author.linkedin %}
                            <li class="nav-item">
                                <a class="nav-link px-2 fs-5" href="https://linkedin.com/in/{{ post.author.linkedin }}" target="_blank"><i class="bi bi-linkedin"></i></a>
                            </li>
                            {% endif %}
                        </ul>                   
                    </div>
                </div>
                <!-- Author info END -->

                <!-- Comments START -->
                <div class="mt-5" id="comments">
                    <h3>{{ comments.count }} comment{{ comments.count|pluralize }}</h3>
                    
                    {% for comment in comments %}
                        {% if comment.is_parent %}
                            {% include 'comments/comment_thread.html' with comment=comment %}
                        {% endif %}
                    {% empty %}
                        <div class="alert alert-info">
                            No comments yet. Be the first to comment!
                        </div>
                    {% endfor %}
                </div>
                <!-- Comments END -->

                <!-- Reply Form START -->
                <div class="mt-5" id="comment-form">
                    <h3>Leave a reply</h3>
                    <small class="text-muted">Your email address will not be published. Required fields are marked *</small>
                    
                    <form method="post" action="{% url 'add_comment' post.id %}" class="row g-3 mt-2" id="commentForm">
                        {% csrf_token %}
                        <input type="hidden" name="parent" id="parent_id" value="">
                        
                        {% if not user.is_authenticated %}
                        <div class="col-md-6">
                            <label class="form-label">Name *</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email *</label>
                            <input type="email" name="email" class="form-control" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Website</label>
                            <input type="url" name="website" class="form-control" placeholder="https://example.com">
                        </div>
                        {% endif %}
                        
                        <!-- Save info checkbox -->
                        <div class="col-md-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="save_info" id="saveInfo">
                                <label class="form-check-label" for="saveInfo">
                                    Save my name and email in this browser for the next time I comment.
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label">Your Comment *</label>
                            <textarea name="content" class="form-control" rows="5" required></textarea>
                        </div>
                        
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">Post Comment</button>
                        </div>
                    </form>
                </div>
                <!-- Reply Form END -->
            </div>
            <!-- Main Content END -->
            
            <!-- Right sidebar START -->
            <div class="col-lg-3">
                <div data-sticky data-margin-top="80" data-sticky-for="991">
                    <!-- Categories -->
                    <div class="row g-2">
                        <h5>Categories</h5>
                        {% for category in categories %}
                        <div class="d-flex justify-content-between align-items-center bg-{{ category.color|default:'primary' }} bg-opacity-10 rounded p-2 position-relative">
                            <h6 class="m-0 text-{{ category.color|default:'primary' }}">{{ category.name }}</h6>
                            <a href="{% url 'category_posts' category.slug %}" class="badge bg-{{ category.color|default:'primary' }} stretched-link">
                                {{ category.post_count }}
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Newsletter START -->
                    <div class="bg-light p-4 mt-4 rounded-3 text-center">
                        <h4>Subscribe to our newsletter!</h4>
                        <form method="post" action="{% url 'newsletter_subscribe' %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <input type="email" name="email" class="form-control" placeholder="Email address" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Subscribe</button>
                            <div class="form-text">We don't spam</div>
                        </form>
                    </div>
                    <!-- Newsletter END -->

                    <!-- Popular Posts -->
                    <div class="mt-4">
                        <h5>Popular Posts</h5>
                        {% for popular_post in popular_posts %}
                        <div class="d-flex align-items-center mb-3">
                            {% if popular_post.featured_image %}
                            <img src="{{ popular_post.featured_image.url }}" class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;" alt="{{ popular_post.title }}">
                            {% endif %}
                            <div>
                                <h6 class="mb-0"><a href="{{ popular_post.get_absolute_url }}">{{ popular_post.title|truncatechars:30 }}</a></h6>
                                <small class="text-muted">{{ popular_post.view_count }} views</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <!-- Right sidebar END -->
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle reply buttons
    document.querySelectorAll('.reply-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const commentId = this.dataset.commentId;
            const authorName = this.dataset.author;
            const replyForm = document.querySelector('#reply-form-' + commentId);
            
            if (replyForm) {
                replyForm.classList.toggle('d-none');
                replyForm.querySelector('input[name="parent"]').value = commentId;
                replyForm.querySelector('textarea').focus();
            }
        });
    });
    
    // Handle cancel reply
    document.querySelectorAll('.cancel-reply').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const replyForm = this.closest('.reply-form');
            if (replyForm) {
                replyForm.classList.add('d-none');
                replyForm.querySelector('textarea').value = '';
            }
        });
    });
    
    // Handle comment voting (AJAX)
    document.querySelectorAll('.vote-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const commentId = this.dataset.commentId;
            const voteType = this.dataset.vote;
            
            fetch(`/comments/${commentId}/vote/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `vote=${voteType}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const upvoteBtn = document.querySelector(`.vote-btn[data-comment-id="${commentId}"][data-vote="1"]`);
                    const downvoteBtn = document.querySelector(`.vote-btn[data-comment-id="${commentId}"][data-vote="-1"]`);
                    const scoreSpan = document.querySelector(`#score-${commentId}`);
                    
                    upvoteBtn.querySelector('.count').textContent = data.upvotes;
                    downvoteBtn.querySelector('.count').textContent = data.downvotes;
                    
                    if (scoreSpan) {
                        scoreSpan.textContent = data.score;
                    }
                    
                    // Update active state
                    if (data.user_vote === 1) {
                        upvoteBtn.classList.add('active');
                        downvoteBtn.classList.remove('active');
                    } else if (data.user_vote === -1) {
                        upvoteBtn.classList.remove('active');
                        downvoteBtn.classList.add('active');
                    } else {
                        upvoteBtn.classList.remove('active');
                        downvoteBtn.classList.remove('active');
                    }
                }
            });
        });
    });
    
    // Handle AJAX comment submission
    const commentForm = document.getElementById('commentForm');
    if (commentForm) {
        commentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add comment to the list
                    const commentsList = document.querySelector('#comments');
                    const newComment = createCommentElement(data.comment);
                    commentsList.insertAdjacentHTML('beforeend', newComment);
                    
                    // Clear form
                    this.reset();
                    
                    // Show success message
                    showNotification('Comment posted successfully!', 'success');
                } else {
                    // Show errors
                    let errorMessage = '';
                    for (let field in data.errors) {
                        errorMessage += `${field}: ${data.errors[field].join(', ')}\n`;
                    }
                    showNotification(errorMessage, 'error');
                }
            });
        });
    }
    
    // Helper function to create comment HTML
    function createCommentElement(comment) {
        return `
            <div class="my-4 d-flex" id="comment-${comment.id}">
                <img class="avatar avatar-md rounded-circle float-start me-3" 
                     src="${comment.avatar || '/static/assets/images/avatar/default.jpg'}" 
                     alt="${comment.author}">
                <div>
                    <div class="mb-2">
                        <h5 class="m-0">${comment.author}</h5>
                        <span class="me-3 small">${comment.created_at}</span>
                        <a href="#" class="text-body fw-normal reply-btn" 
                           data-comment-id="${comment.id}" 
                           data-author="${comment.author}">Reply</a>
                    </div>
                    <p>${comment.content}</p>
                </div>
            </div>
        `;
    }
    
    // Helper function to show notifications
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
        notification.setAttribute('role', 'alert');
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        const container = document.querySelector('.container');
        container.insertBefore(notification, container.firstChild);
        
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }
});
</script>
{% endblock %}