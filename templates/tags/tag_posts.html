{% extends 'base.html' %}
{% load static %}

{% block title %}#{{ tag.name }} - Tag{% endblock %}
{% block description %}Explore all posts tagged with #{{ tag.name }}. {{ total_posts }} post{{ total_posts|pluralize }} available.{% endblock %}

{% block content %}

<!-- =======================
Inner intro START -->
<section class="pt-4">
	<div class="container">
		<div class="row justify-content-center text-center">
			<div class="col-md-8">
				<div class="display-1 text-primary">#{{ tag.name }}</div>
				<p class="lead">{{ total_posts }} post{{ total_posts|pluralize }} in this tag</p>
				<!-- breadcrumb -->
				<nav class="d-flex justify-content-center" aria-label="breadcrumb">
					<ol class="breadcrumb breadcrumb-dots mb-0">
						<li class="breadcrumb-item"><a href="{% url 'home' %}"><i class="bi bi-house me-1"></i> Home</a></li>
						<li class="breadcrumb-item"><a href="{% url 'tag_list' %}">Tags</a></li>
						<li class="breadcrumb-item active">#{{ tag.name }}</li>
					</ol>
				</nav>
			</div>
		</div>
	</div>
</section>
<!-- =======================
Inner intro END -->

<!-- =======================
Main content START -->
<section class="position-relative pt-0">
	<div class="container" data-sticky-container>
		<div class="row">
			<!-- Main Post START -->
			<div class="col-lg-9">
				{% if posts %}
				<div class="row gy-4">
					{% for post in posts %}
					<!-- Card item START -->
					<div class="col-sm-6">
						<div class="card h-100">
							<!-- Card img -->
							<div class="position-relative">
								{% if post.featured_image %}
								<img class="card-img" src="{{ post.featured_image.url }}" alt="{{ post.title }}" style="height: 200px; object-fit: cover;">
								{% else %}
								<img class="card-img" src="{% static 'assets/images/blog/4by3/01.jpg' %}" alt="{{ post.title }}" style="height: 200px; object-fit: cover;">
								{% endif %}
								<div class="card-img-overlay d-flex align-items-start flex-column p-3">
									<!-- Card overlay Top - Media type indicator -->
									{% if post.get_media_type == 'video' %}
									<div class="w-100 d-flex justify-content-end mb-auto">
										<div class="text-end ms-auto">
											<div class="icon-md bg-white bg-opacity-25 bg-blur text-white rounded-circle" title="This post has video">
												<i class="fas fa-video"></i>
											</div>
										</div>
									</div>
									{% elif post.get_media_type == 'audio' %}
									<div class="w-100 d-flex justify-content-end mb-auto">
										<div class="text-end ms-auto">
											<div class="icon-md bg-white bg-opacity-25 bg-blur text-white rounded-circle" title="This post has audio">
												<i class="fas fa-volume-up"></i>
											</div>
										</div>
									</div>
									{% endif %}
									<!-- Card overlay bottom -->
									<div class="w-100 mt-auto">
										<!-- Card category -->
										{% if post.category %}
										<a href="{% url 'category_posts' post.category.slug %}" class="badge text-bg-warning mb-2">
											<i class="fas fa-circle small fw-bold me-2"></i>{{ post.category.name }}
										</a>
										{% endif %}
									</div>
								</div>
							</div>
							<div class="card-body px-0 pt-3">
								<h4 class="card-title">
									<a href="{{ post.get_absolute_url }}" class="btn-link text-reset fw-bold">{{ post.title|truncatechars:60 }}</a>
								</h4>
								<p class="card-text">{{ post.excerpt|default:post.content|striptags|truncatechars:100 }}</p>
								<!-- Card info -->
								<ul class="nav nav-divider align-items-center d-none d-sm-inline-block">
									<li class="nav-item">
										<div class="nav-link">
											<div class="d-flex align-items-center position-relative">
												<div class="avatar avatar-xs">
													{% if post.author.profile_picture %}
													<img class="avatar-img rounded-circle" src="{{ post.author.profile_picture.url }}" alt="{{ post.author.username }}">
													{% else %}
													<div class="avatar-img rounded-circle bg-primary d-flex align-items-center justify-content-center text-white">
														{{ post.author.username|slice:":2"|upper }}
													</div>
													{% endif %}
												</div>
												<span class="ms-3">
													{% if post.author %}
													by <a href="{% url 'author_profile' post.author.username %}" class="stretched-link text-reset btn-link">{{ post.author.get_full_name|default:post.author.username }}</a>
													{% else %}
													by <span class="text-muted">Unknown Author</span>
													{% endif %}
												</span>
											</div>
										</div>
									</li>
									<li class="nav-item">{{ post.published_date|date:"M d, Y" }}</li>
								</ul>
							</div>
						</div>
					</div>
					<!-- Card item END -->
					{% endfor %}
					
					<!-- Pagination START -->
					{% if posts.has_other_pages %}
					<div class="col-12 mt-5">
						<nav aria-label="Page navigation">
							<ul class="pagination justify-content-center">
								{% if posts.has_previous %}
								<li class="page-item">
									<a class="page-link" href="?page={{ posts.previous_page_number }}" aria-label="Previous">
										<span aria-hidden="true">&laquo;</span>
									</a>
								</li>
								{% else %}
								<li class="page-item disabled">
									<span class="page-link" aria-hidden="true">&laquo;</span>
								</li>
								{% endif %}
								
								{% for num in posts.paginator.page_range %}
									{% if posts.number == num %}
									<li class="page-item active"><span class="page-link">{{ num }}</span></li>
									{% elif num > posts.number|add:'-3' and num < posts.number|add:'3' %}
									<li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
									{% endif %}
								{% endfor %}
								
								{% if posts.has_next %}
								<li class="page-item">
									<a class="page-link" href="?page={{ posts.next_page_number }}" aria-label="Next">
										<span aria-hidden="true">&raquo;</span>
									</a>
								</li>
								{% else %}
								<li class="page-item disabled">
									<span class="page-link" aria-hidden="true">&raquo;</span>
								</li>
								{% endif %}
							</ul>
						</nav>
					</div>
					{% endif %}
					<!-- Pagination END -->
					
					<!-- Load more button (alternative to pagination) -->
					{% if posts.has_next %}
					<div class="col-12 text-center mt-5">
						<a href="?page={{ posts.next_page_number }}" class="btn btn-primary-soft load-more-btn" data-next-page="{{ posts.next_page_number }}">
							Load more posts <i class="bi bi-arrow-down-circle align-middle ms-2"></i>
						</a>
					</div>
					{% endif %}
				</div>
				{% else %}
				<!-- No posts -->
				<div class="text-center py-5">
					<div class="icon-lg bg-light rounded-circle mb-3 mx-auto d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
						<i class="bi bi-tag fs-1 text-muted"></i>
					</div>
					<h3>No posts yet</h3>
					<p class="text-muted">There are no posts tagged with #{{ tag.name }} yet.</p>
					<a href="{% url 'tag_list' %}" class="btn btn-primary">Browse Other Tags</a>
				</div>
				{% endif %}
			</div>
			<!-- Main Post END -->
			
			<!-- Sidebar START -->
			<div class="col-lg-3 mt-5 mt-lg-0">
				<div data-sticky data-margin-top="80" data-sticky-for="991">
					
					<!-- Related Tags Widget -->
					{% if related_tags %}
					<div class="card mb-4">
						<div class="card-header bg-light">
							<h5 class="mb-0">Related Tags</h5>
						</div>
						<div class="card-body">
							<ul class="list-inline mb-0">
								{% for related_tag in related_tags %}
								<li class="list-inline-item mb-2">
									<a href="{% url 'tag_posts' related_tag.slug %}" class="btn btn-sm btn-outline-secondary">
										#{{ related_tag.name }}
										<span class="badge bg-secondary bg-opacity-10 text-secondary ms-1">{{ related_tag.count }}</span>
									</a>
								</li>
								{% endfor %}
							</ul>
						</div>
					</div>
					{% endif %}
					
					<!-- Top Authors Widget -->
					{% if top_authors %}
					<div class="card mb-4">
						<div class="card-header bg-light">
							<h5 class="mb-0">Top Authors in #{{ tag.name }}</h5>
						</div>
						<div class="card-body">
							{% for author in top_authors %}
							<div class="d-flex align-items-center mb-3">
								<div class="avatar avatar-sm me-2">
									{% if author.profile_picture %}
									<img class="avatar-img rounded-circle" src="{{ author.profile_picture.url }}" alt="{{ author.username }}">
									{% else %}
									<div class="avatar-img rounded-circle bg-primary d-flex align-items-center justify-content-center text-white">
										{{ author.username|slice:":2"|upper }}
									</div>
									{% endif %}
								</div>
								<div>
									<a href="{% url 'author_profile' author.username %}" class="text-reset fw-bold">{{ author.get_full_name|default:author.username }}</a>
									<small class="text-muted d-block">{{ author.post_count }} post{{ author.post_count|pluralize }} in this tag</small>
								</div>
							</div>
							{% endfor %}
						</div>
					</div>
					{% endif %}
					
					<!-- Popular Tags Widget -->
					<div class="card mb-4">
						<div class="card-header bg-light">
							<h5 class="mb-0">Popular Tags</h5>
						</div>
						<div class="card-body">
							<ul class="list-inline mb-0">
								{% for popular_tag in popular_tags|slice:":10" %}
								<li class="list-inline-item mb-2">
									<a href="{% url 'tag_posts' popular_tag.slug %}" class="btn btn-sm btn-primary-soft">
										#{{ popular_tag.name }}
									</a>
								</li>
								{% empty %}
								<li class="list-inline-item">
									<p class="text-muted mb-0">No tags available</p>
								</li>
								{% endfor %}
							</ul>
							<div class="mt-3 text-center">
								<a href="{% url 'tag_list' %}" class="btn btn-link p-0">View all tags <i class="bi bi-arrow-right ms-1"></i></a>
							</div>
						</div>
					</div>
					
					<!-- Subscribe Widget -->
					<div class="card bg-primary text-white">
						<div class="card-body">
							<h5>Follow #{{ tag.name }}</h5>
							<p class="opacity-75">Get notified when new posts are published in this tag.</p>
							<form action="{% url 'newsletter_subscribe' %}" method="POST" class="mt-3">
								{% csrf_token %}
								<input type="hidden" name="tag" value="{{ tag.slug }}">
								<div class="input-group">
									<input type="email" class="form-control" name="email" placeholder="Your email" required>
									<button class="btn btn-light" type="submit">
										<i class="bi bi-bell"></i>
									</button>
								</div>
								<small class="opacity-75 d-block mt-2">We'll never share your email with anyone else.</small>
							</form>
						</div>
					</div>
				</div>
			</div>
			<!-- Sidebar END -->
		</div> <!-- Row end -->
	</div>
</section>
<!-- =======================
Main content END -->

{% endblock %}

{% block extra_js %}
<script>
	document.addEventListener('DOMContentLoaded', function() {
		// Load more posts with AJAX
		const loadMoreBtn = document.querySelector('.load-more-btn');
		if (loadMoreBtn) {
			loadMoreBtn.addEventListener('click', function(e) {
				e.preventDefault();
				const nextPage = this.dataset.nextPage;
				const currentUrl = window.location.pathname;
				
				fetch(`${currentUrl}?page=${nextPage}`, {
					headers: {
						'X-Requested-With': 'XMLHttpRequest',
					}
				})
				.then(response => response.text())
				.then(html => {
					// Parse the HTML response
					const parser = new DOMParser();
					const doc = parser.parseFromString(html, 'text/html');
					
					// Get the new posts
					const newPosts = doc.querySelectorAll('.col-sm-6');
					const postsContainer = document.querySelector('.row.gy-4');
					
					// Append new posts
					newPosts.forEach(post => {
						postsContainer.appendChild(post.cloneNode(true));
					});
					
					// Update next page number
					const newLoadMoreBtn = doc.querySelector('.load-more-btn');
					if (newLoadMoreBtn) {
						loadMoreBtn.dataset.nextPage = newLoadMoreBtn.dataset.nextPage;
					} else {
						// No more pages
						loadMoreBtn.remove();
						
						// Show pagination if available
						const pagination = doc.querySelector('.pagination');
						if (pagination) {
							document.querySelector('.col-12.mt-5').innerHTML = pagination.outerHTML;
						}
					}
				})
				.catch(error => {
					console.error('Error loading more posts:', error);
				});
			});
		}
	});
</script>
{% endblock %}